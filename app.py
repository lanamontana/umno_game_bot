from flask import Flask, render_template, request, redirect, url_for, session
import random
from datetime import datetime
from dotenv import load_dotenv
import os

from gpt_utils import generate_gpt_question

load_dotenv()

app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET_KEY", "mysecretkey")

QUESTIONS = {
    "smart": ["Что такое квантовая запутанность?",
    "Что такое когнитивное искажение?",
    "Если бы ты мог задать один вопрос любому учёному, кто бы это был и что бы ты спросил?",
    "Какая книга изменила твоё мышление?",
    "Веришь ли ты в судьбу, или всё зависит от выбора?",
    "Какая идея тебя вдохновляет в последние месяцы?",
    "Если бы ты мог освоить любую науку за один день — что бы это было и почему?",
    "Как ты думаешь, возможна ли дружба между очень разными по мировоззрению людьми?",
    "Какой самый неожиданный факт ты узнал(а) в этом году?",
    "Что важнее: интеллект или эмпатия?",
    "Если бы ты стал(а) учителем, чему бы ты учил(а)?",
    "Какие знания ты считаешь недооценёнными?",
    "Что такое личная философия для тебя?",
    "Как ты понимаешь фразу 'осознанная жизнь'?",
    "Веришь ли ты, что мозг может влиять на материальность?",
    "Какие открытия в науке тебя вдохновляют?",
    "Если бы ты мог спросить у Вселенной что угодно, что бы это было?",
    "С каким парадоксом ты недавно столкнулся?",
    "Что для тебя значит развитие?",
    "Какой момент в жизни был для тебя настоящим 'инсайтом'?",
    "Как ты относишься к искусственному интеллекту?",
    "В чём разница между знанием и мудростью?",
    "Какие идеи ты бы хотел(а) воплотить в жизнь?",
    "Если бы ты создал(а) свой подкаст, о чём он был бы?",
    "Как ты определяешь, что что-то 'умно'?",
    "Какие три вещи должен знать каждый человек, по твоему мнению?",
    "Если бы ты мог отменить одно правило в обществе — что бы это было и почему?",
    "Как бы выглядел твой идеальный день, если бы ты сам управлял временем?",
    "Какая книга или фильм изменила твоё мышление?","Ты веришь в свободу воли или всё предопределено?",
    "Что важнее: интеллект или эмпатия?",
    "Что бы ты сделал, если бы на день стал невидимым?",
    "Можно ли дружить с искусственным интеллектом?",
    "Как бы ты объяснил человечество инопланетянам за 30 секунд?",
    "С какой исторической личностью ты бы хотел поговорить и о чём?",
    "Что такое взрослая жизнь — по-твоему?",
    "Если бы ты мог стереть одно воспоминание, стер бы?",
    "Что такое 'нормальность' и существует ли она вообще?",
    "Что делает человека настоящим другом?",
    "Если бы каждый человек имел суперсилу, какая бы тебе не понравилась у других?",
    "Какие знания тебе дали больше всего силы в жизни?",
    "Ты бы предпочёл знать всё или уметь забывать?",
    "Какая у тебя была самая неожиданная мысль за последнее время?",
    "Ты за равенство возможностей или равенство результатов?",
    "Какое открытие ты хотел бы сделать лично?",
    "В чём сила твоего поколения?",
    "Что бы ты сказал себе в 10 лет?",
    "Какие привычки делают человека сильным?",
    "Можно ли быть счастливым, если ты не реализуешь свой потенциал?",
    "Ты бы хотел, чтобы люди читали мысли друг друга?",
    "Что важнее: быть нужным или быть свободным?"],
    "weird": ["Что бы ты сделал, если бы оказался на Марсе?", 
    "Что бы ты сделал, если бы однажды проснулся в теле голубя?",
    "Какой овощ тебе ближе по характеру и почему?",
    "Если бы у тебя был хвост, как бы ты им пользовался?",
    "Ты попал в мультик 'Губка Боб'. Кто ты и что делаешь?",
    "Какой заговор ты бы придумал для картошки?",
    "Если бы обувь могла говорить, что бы она рассказала о тебе?",
    "Ты можешь общаться только пением — что первое ты споёшь?",
    "Какое заклинание ты бы придумал, чтобы исчезать с неловких свиданий?",
    "Если бы еда могла мстить — за что бы тебя наказала пицца?",
    "Твоя рука превращается в предмет — какой именно и зачем?",
    "Ты стал запахом. Чем ты пахнешь и кого это радует/бесит?",
    "Если бы в мире остался только один звук — какой бы ты выбрал?",
    "Что бы ты сказал своей тени, если бы она заговорила?",
    "Ты в прошлом и должен объяснить людям, что такое Wi-Fi. Как бы ты это сделал?",
    "Если бы у тебя был язык только из мемов — как бы ты объяснял чувства?",
    "Ты можешь понять язык животных. С кем первым заговоришь и о чём?",
    "Какой предмет из школы ты бы запретил и чем заменил?",
    "Если бы тебе пришлось носить только один костюм навсегда — что бы это было?",
    "Ты стал приложением в телефоне. Как ты работаешь?",
    "Какой нелепый страх ты мог бы придумать, чтобы всех сбить с толку?",
    "Ты можешь призывать только один предмет — какой и зачем?",
    "Если бы тебе пришлось жить в мире одного цвета, какой бы ты выбрал?",
    "Ты выиграл миллион, но можешь тратить только на странные вещи. На что пошли бы деньги?",
    "Какое твоё качество больше всего бы бесило инопланетян?",
    "Если бы в холодильнике был портал — куда он ведёт?",
    "Ты стал голосом навигатора. Что ты говоришь водителю?",
    "Какой самый нелепый супергерой ты можешь придумать?",
    "Если бы ты был вкусом жвачки, каким?",
    "Ты можешь танцевать только одним движением. Какое это движение?",
    "Если бы носы могли спорить — о чём бы спорил твой?",
    "Ты получил письмо от себя из 3024 года. Что там написано?",
    "Ты попал в сон другого человека. Что ты там делаешь?",
    "Если бы твоё настроение было одеждой — что бы ты сейчас носил?",
    "Что бы ты кричал, если бы оказался в телешоу про енотов?",
    "Ты стал телевизором. Что ты показываешь каждый день?",
    "Какой музыкальный инструмент описывает твою душу?",
    "Ты в команде с ведьмой. Какое твоё заклинание?",
    "Если бы твой стул мог говорить — что бы он сказал?",
    "Ты стал эмоцией. Как ты выглядишь и как проявляешься?",
    "Если бы зеркала показывали не отражение, а суть — что бы ты там увидел?",
    "Какой звук ты бы издал, если бы был дверью?",
    "Если бы у тебя был мозг как Google-поиск — что бы было в истории?",
    "Какой твой обычный день в роли супер-зубной щётки?",
    "Если бы ты жил внутри холодильника — кем бы ты там был?",
    "Какой танец лучше всего описывает твой внутренний мир?",
    "Если бы ты разговаривал с носком — о чём был бы ваш спор?",
    "Ты можешь телепортироваться, но только в туалеты. Как используешь дар?",
    "Если бы ты был будильником, кого бы ты бесил больше всего?",
    "Какая твоя суперспособность, о которой никто не просил?",
    "Если бы ты стал интернет-мемом, как бы он назывался?",
    "Какую самую странную работу ты мог бы придумать для себя?"],
    "intimate": ["Что тебя больше всего ранило в любви?",
    "Что ты чувствуешь прямо сейчас, но редко говоришь об этом?",
    "Когда ты в последний раз чувствовал себя по-настоящему любимым?",
    "Какая часть тебя остаётся скрытой от большинства?",
    "Чего ты больше всего боишься в отношениях?",
    "Был ли момент, когда ты чувствовал, что тебя никто не понимает?",
    "Что для тебя значит настоящая близость?",
    "Когда ты в последний раз плакал и почему?",
    "Кто оказал на тебя наибольшее эмоциональное влияние?",
    "Как ты распознаёшь, что влюблён?",
    "Что бы ты хотел, чтобы друзья знали о тебе, но ты молчишь?",
    "Какое воспоминание тебя греет, даже спустя годы?",
    "Какие слова ты мечтаешь услышать от кого-то?",
    "Какая часть твоего тела вызывает у тебя неуверенность?",
    "Что тебе особенно важно в эмоциональной связи?",
    "Ты когда-нибудь терял себя в отношениях?",
    "Что ты скрываешь, потому что боишься быть уязвимым?",
    "Какой твой самый глубокий страх в дружбе?",
    "Что тебе нужно, чтобы чувствовать себя в безопасности?",
    "Были ли у тебя нереализованные чувства к другу?",
    "Что тебя может растрогать до слёз?",
    "Какая интимная мысль посещает тебя чаще, чем хотелось бы?",
    "Когда ты впервые почувствовал себя настоящим собой?",
    "Есть ли у тебя секрет, которым ты хочешь поделиться?",
    "Что ты считаешь своим самым сильным качеством в любви?",
    "Когда ты в последний раз чувствовал одиночество в компании?",
    "Ты когда-нибудь чувствовал, что любишь «неправильно»?",
    "Какая твоя потребность чаще всего остаётся неудовлетворённой?",
    "Ты умеешь просить о помощи? Почему?",
    "Когда ты чувствовал, что тебя по-настоящему видят?",
    "Какая эмоция тебе даётся сложнее всего?",
    "Какое признание далось тебе труднее всего?",
    "С кем ты был по-настоящему честен в своей жизни?",
    "Какая у тебя была самая нежная дружба?",
    "Что ты чувствуешь, когда кто-то проявляет к тебе заботу?",
    "Что для тебя важнее — быть любимым или понимать, что ты нужен?",
    "Бывали ли моменты, когда ты притворялся сильнее, чем есть?",
    "Что в тебе ранит чаще всего в отношениях?",
    "Что ты ценишь больше всего в эмоциональной близости?",
    "Когда ты чувствуешь себя по-настоящему красивым?",
    "Чего ты бы хотел больше в своей жизни прямо сейчас?",
    "Когда ты чувствовал, что можешь быть собой на 100%?",
    "Что ты считаешь самой хрупкой частью своей личности?",
    "Как ты справляешься с эмоциональной болью?",
    "Какое объятие ты помнишь до сих пор?",
    "Что ты хочешь услышать от близкого друга прямо сейчас?",
    "Какая форма поддержки тебе ближе всего?",
    "Как ты относишься к уязвимости — в себе и в других?",
    "Бывали ли моменты, когда ты любил, но не мог это сказать?",
    "Ты когда-нибудь боялся быть отвергнутым за то, кто ты есть?",
    "Если бы ты мог сейчас поговорить с собой из прошлого, что бы сказал?"],
    "action": ["Сделай другому участнику комплимент",
    "Поменяй аватарку в мессенджере на свою детскую фотку — на 1 час.",
    "Изобрази любое животное, пока остальные не угадают.",
    "Скажи самую скучную фразу максимально драматичным тоном.",
    "Сыграй короткую сценку: ты на собеседовании в космонавты.",
    "Встань и станцуй, будто на тебя смотрят только растения.",
    "Придумай и скажи новый девиз нашей компании.",
    "Назови слово, а следующий игрок должен придумать рифму и станцевать её.",
    "Сделай лицо, как будто ты только что выиграл миллион.",
    "Изобрази свой обычный утренний сбор, но в ускоренной версии.",
    "Покажи, как ты реагируешь на неожиданный подарок.",
    "Скажи всем комплимент, но начни с фразы «ты, конечно, странный(ая), но...»",
    "Говори только шёпотом в течение следующего раунда.",
    "Сделай фейковый звонок и придумай абсурдную причину отказа от встречи.",
    "Представь, что ты ведущий телемагазина, и продай невидимый предмет.",
    "Выбери друга и попытайся синхронно двигаться с ним 10 секунд.",
    "Придумай и покажи новый танец для соцсетей.",
    "Сделай вдохновляющую речь про сыр или хлеб.",
    "Покажи, как бы ты вел себя на кастинге в хоррор-фильм.",
    "Сыграй себя в параллельной вселенной: как ты разговариваешь?",
    "Открой ближайший шкаф/ящик и покажи первый предмет, сказав о нём 3 факта.",
    "Придумай лайфхак, который звучит разумно, но бесполезен.",
    "Сыграй импровизированную сценку: ты робот с багами.",
    "Назови 3 своих сильных качества, но с выражением полной неуверенности.",
    "Изобрази себя на премии 'Лучший друг года'.",
    "Придумай и расскажи миф, почему понедельник — это проклятый день.",
    "Выбери случайное слово и придумай для него религию.",
    "Изобрази, как бы ты выглядел, если бы был супергероем-паникёром.",
    "Веди себя 1 минуту, как будто ты суперзвезда, которую никто не узнал.",
    "Изобрази, как ты входишь в комнату, зная, что там все тебя обсуждали.",
    "Представь, что у тебя 3 головы — говори поочередно от каждой.",
    "Придумай и сделай боевой клич нашей команды.",
    "Сделай вид, что у тебя интервью на ТВ. Отвечай на вымышленные вопросы.",
    "Объяви сам себе номинацию и поблагодари за неё.",
    "Произнеси любую фразу на 'инопланетном' языке, переведи.",
    "Попробуй рекламировать наш чат, будто это самый крутой продукт на рынке.",
    "Опиши вкус своего настроения сегодня.",
    "Покажи, как ты танцуешь, когда тебя никто не видит.",
    "Притворись, что ты голосовой помощник. Говори, как робот.",
    "Покажи, как ты просыпаешься, если опоздал(а) на важное.",
    "Попроси у каждого игрока 'ментальную подпись' — придумай, что это.",
    "Нарисуй не глядя аватарку следующего игрока.",
    "Поставь таймер и скажи как можно больше слов на букву «К».",
    "Объясни, как работает зубная щётка, будто ты профессор.",
    "Скажи что-то важное, но с выражением полной бессмысленности.",
    "Притворись, что ты в рекламе странного сервиса и покажи промо.",
    "Назови своё альтер-эго и расскажи его секрет.",
    "Построй логическую цепочку из слов, которые назовут другие.",
    "Изобрази, как выглядел бы твой день, если бы ты был(а) котом.",
    "Назови новый закон физики, придумай его объяснение.",
    "Веди себя как персонаж из мультика — 1 минуту."]
}

CATEGORY_NAMES = {
    "smart": "♣️ Умное",
    "weird": "♦️ Странное",
    "intimate": "♥️ Интимное",
    "action": "♠️ Действие"
}

@app.route('/')
def intro():
    return render_template('intro.html')

@app.route('/menu')
def menu():
    return render_template('index.html', category_names=CATEGORY_NAMES)

@app.route("/category/<category>")
def category(category):
    if category not in QUESTIONS:
        return render_template("chat.html", error="Категория не найдена.")

    question = random.choice(QUESTIONS[category])
    return render_template('chat.html',
                           question=question,
                           category=category,
                           category_names=CATEGORY_NAMES)

@app.route('/random_card')
def random_card():
    category = random.choice(list(QUESTIONS.keys()))
    question = random.choice(QUESTIONS[category])
    return render_template('chat.html',
                           question=question,
                           category=category,
                           category_names=CATEGORY_NAMES)

@app.route('/admin')
def admin():
    return render_template('admin.html', categories=CATEGORY_NAMES)

@app.route('/admin/add_question', methods=['POST'])
def add_question():
    category = request.form.get('category')
    question = request.form.get('question')

    if category in QUESTIONS and question:
        QUESTIONS[category].append(question.strip())
    return redirect(url_for('admin'))

@app.route('/clear_chat', methods=['POST'])
def clear_chat():
    session['chat_history'] = []
    session.modified = True
    return redirect(url_for('index'))

@app.route('/start/<category>')
def start(category):
    if category not in QUESTIONS:
        return redirect(url_for('index'))

    if 'chat_history' not in session:
        session['chat_history'] = []

    # Добавляем выбор категории в историю
    session['chat_history'].append({
        'type': 'user',
        'message': CATEGORY_NAMES[category],
        'timestamp': datetime.now().strftime('%H:%M')
    })

    # Пробуем получить вопрос от GPT
print("⚙️ Запрашиваю GPT-вопрос...")
    gpt_question = generate_gpt_question(category)
 print("🎯 GPT ответ:", gpt_question)   
    if gpt_question:
        question = gpt_question
    else:
        question = random.choice(QUESTIONS[category])

    # Добавляем вопрос от бота
    session['chat_history'].append({
        'type': 'bot',
        'message': f"📝 {question}",
        'timestamp': datetime.now().strftime('%H:%M')
    })

    session.modified = True
    return redirect(url_for('index'))

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000, debug=True)